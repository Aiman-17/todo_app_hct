# Implementation Plan: Phase II - Full-Stack Web Application with Authentication

**Branch**: `002-fullstack-web-auth` | **Date**: 2025-12-30 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-fullstack-web-auth/spec.md`

## Summary

Phase II transforms the console todo application into a production-grade full-stack web application with secure user authentication. The backend migrates from in-memory storage to Neon PostgreSQL using SQLModel ORM, exposing a RESTful API built with FastAPI. The frontend is a Next.js 16+ App Router application with TypeScript, Tailwind CSS, and shadcn/ui components. Better Auth handles JWT-based authentication (15-minute access tokens, 7-day refresh tokens) with bcrypt password hashing. All task operations are user-isolated via user_id filtering, ensuring complete data privacy. The architecture maintains strict separation: frontend consumes backend APIs exclusively via `/api/*` endpoints with no direct database access.

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript 5+ with strict mode (frontend)
**Primary Dependencies**: FastAPI, Uvicorn, SQLModel, Better Auth (backend); Next.js 16+, React 19+, shadcn/ui, Better Auth (frontend)
**Storage**: Neon Serverless PostgreSQL with connection pooling
**Testing**: pytest for backend unit/integration tests, Jest/React Testing Library for frontend
**Target Platform**: Web application (desktop/tablet/mobile responsive), development on localhost, production-ready architecture
**Project Type**: Web (backend + frontend)
**Performance Goals**: <2s CRUD operations, <5s login-to-dashboard flow, <200ms API p95 latency
**Constraints**: Frontend MUST NOT access database directly; Backend MUST use SQLModel (NO raw SQL); All protected routes MUST verify JWT; Tasks MUST be isolated by user_id
**Scale/Scope**: MVP for single-user local development, designed to scale to 10k+ users in future phases

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| **I. Spec-First Development** | PASS | Complete spec.md exists at `specs/002-fullstack-web-auth/spec.md` with 25 FRs, 10 SCs, 4 user stories, and clarifications |
| **II. Agent-Centric Workflow** | PASS | Plan follows TodoMasterAgent → specialized agent delegation model; TaskCRUDAgent handles CRUD, AuthenticationAgent handles JWT |
| **III. Skill Reusability** | DEFER | No reusable skills identified in Phase II scope; will extract common patterns (CRUD operations, JWT middleware) as skills in Phase III+ |
| **IV. Phase-Based Evolution** | PASS | Builds on Phase I foundation (Task model, service layer patterns); maintains backward-compatible data model (title, description, completed) while adding user_id; Next phases (III-V) depend on this authentication foundation |
| **V. Quality & Compliance** | PASS | Spec defines testable acceptance criteria; Test strategy includes unit (models, services), integration (API endpoints), and contract tests (OpenAPI validation) |
| **VI. Event-Driven Architecture** | DEFER | Phase II uses synchronous REST API; Event-driven architecture (Kafka/Dapr) introduced in Phase IV per constitution |
| **VII. Security** | PASS | JWT authentication mandatory on all protected endpoints; bcrypt password hashing; user_id-based data isolation; BETTER_AUTH_SECRET environment variable; HTTPS planned for production (Phase V) |

**Overall Status**: PASS with 2 intentional DEFERs (Kafka/Dapr in Phase IV per constitution roadmap)

## Project Structure

### Documentation (this feature)

```text
specs/002-fullstack-web-auth/
├── plan.md              # This file
├── research.md          # Technology integration research (Better Auth, SQLModel, Next.js 16, Neon)
├── data-model.md        # Database schema (Users, Tasks tables with SQLModel definitions)
├── quickstart.md        # Local development setup instructions
├── contracts/
│   └── openapi.yaml     # OpenAPI 3.0.3 spec (11 endpoints, auth + tasks)
└── tasks.md             # Generated by /sp.tasks (NOT part of plan.md output)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── __init__.py
│   ├── main.py                    # FastAPI app entry point, CORS, APIRouter registration
│   ├── config.py                  # Environment config (DATABASE_URL, BETTER_AUTH_SECRET, CORS_ORIGINS)
│   ├── database.py                # SQLModel engine, session management, Neon connection pooling
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py                # User SQLModel (id UUID, email, name, password_hash, timestamps)
│   │   └── task.py                # Task SQLModel (id int, user_id FK, title, description, completed, timestamps)
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── auth.py                # Pydantic schemas (UserCreate, UserLogin, UserResponse, TokenResponse)
│   │   └── task.py                # Pydantic schemas (TaskCreate, TaskUpdate, TaskResponse)
│   ├── services/
│   │   ├── __init__.py
│   │   ├── auth_service.py        # Better Auth integration, JWT issue/verify, bcrypt hashing
│   │   └── task_service.py        # Task CRUD operations with user_id filtering
│   ├── api/
│   │   ├── __init__.py
│   │   ├── deps.py                # Dependency injection (get_current_user, get_db_session)
│   │   ├── auth.py                # Auth endpoints (/signup, /login, /refresh, /logout, /me)
│   │   └── tasks.py               # Task endpoints (/tasks CRUD + /toggle)
│   └── middleware/
│       ├── __init__.py
│       └── auth_middleware.py     # JWT validation middleware
├── tests/
│   ├── __init__.py
│   ├── conftest.py                # pytest fixtures (test DB, test client, auth headers)
│   ├── unit/
│   │   ├── test_models.py         # SQLModel validation tests
│   │   └── test_services.py       # Service layer unit tests
│   ├── integration/
│   │   ├── test_auth_api.py       # Auth endpoints integration tests
│   │   └── test_tasks_api.py      # Task endpoints integration tests
│   └── contract/
│       └── test_openapi.py        # OpenAPI schema validation
├── alembic/                       # Database migrations (future)
├── .env.example                   # Template for environment variables
├── requirements.txt               # Python dependencies
├── pyproject.toml                 # Python project metadata
└── README.md                      # Backend setup instructions

frontend/
├── src/
│   ├── app/
│   │   ├── layout.tsx             # Root layout (metadata, fonts, Providers)
│   │   ├── page.tsx               # Landing page (redirects to /login or /dashboard)
│   │   ├── login/
│   │   │   └── page.tsx           # Login page (Client Component)
│   │   ├── signup/
│   │   │   └── page.tsx           # Signup page (Client Component)
│   │   └── dashboard/
│   │       ├── layout.tsx         # Protected layout (auth check)
│   │       └── page.tsx           # Task dashboard (Server Component fetches, Client Component for interactions)
│   ├── components/
│   │   ├── ui/                    # shadcn/ui components (button, input, card, modal, etc.)
│   │   ├── auth/
│   │   │   ├── LoginForm.tsx      # Login form with validation
│   │   │   └── SignupForm.tsx     # Signup form with password validation
│   │   ├── tasks/
│   │   │   ├── TaskList.tsx       # Task list display
│   │   │   ├── TaskItem.tsx       # Single task card with edit/delete/toggle
│   │   │   ├── TaskForm.tsx       # Create/edit task form
│   │   │   └── DeleteConfirmModal.tsx  # Delete confirmation modal
│   │   └── shared/
│   │       ├── Header.tsx         # App header with logout
│   │       └── LoadingSpinner.tsx # Loading state component
│   ├── lib/
│   │   ├── api.ts                 # API client (fetch wrapper with auth headers)
│   │   ├── auth.ts                # Better Auth client configuration
│   │   └── utils.ts               # shadcn/ui cn() utility
│   ├── types/
│   │   ├── auth.ts                # TypeScript types for User, LoginRequest, SignupRequest, TokenResponse
│   │   └── task.ts                # TypeScript types for Task, TaskCreate, TaskUpdate
│   └── middleware.ts              # Next.js middleware for protected routes
├── public/                        # Static assets
├── tests/
│   ├── unit/
│   │   └── components/            # Component unit tests
│   └── integration/
│       └── api/                   # API integration tests
├── .env.local.example             # Template for environment variables
├── package.json                   # Node dependencies
├── tsconfig.json                  # TypeScript configuration (strict mode)
├── tailwind.config.ts             # Tailwind CSS configuration
├── next.config.mjs                # Next.js configuration
└── README.md                      # Frontend setup instructions

# Shared/Root files
.gitignore                         # Ignore node_modules, .env files, build artifacts
README.md                          # Project overview, quick start, phase roadmap
```

**Structure Decision**: Web application structure (Option 2) selected because Phase II introduces frontend + backend separation. Backend maintains similarity to Phase I structure (`src/models`, `src/services`) for smooth migration while adding `api/` for RESTful endpoints. Frontend follows Next.js 16 App Router conventions with `app/` directory structure. Tests mirror source structure for both projects. This structure scales cleanly to Phase III (add chatbot service) and Phase IV (containerize backend/frontend separately).

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected. All DEFERs are intentional per constitution roadmap (Kafka/Dapr in Phase IV).
